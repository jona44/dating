{% extends "base.html" %}
{% block content %}

<div class="max-w-4xl mx-auto py-8 px-4" hx-ext="ws" ws-connect="/ws/chat/{{ conversation.id }}/">
  
  <!-- Header with presence indicator -->
  <div class="bg-white rounded-t-2xl p-4 border-b flex items-center justify-between">
    <div class="flex items-center gap-3">
      {% for p in conversation.participants.all %}
        {% if p != profile %}
          <!-- Profile Picture -->
          <div class="relative">
            <div class="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden">
              {% if p.profile_picture %}
                <img src="{{ p.profile_picture.url }}" alt="{{ p.display_name }}" class="w-full h-full object-cover">
              {% else %}
                <span class="text-xl">üë§</span>
              {% endif %}
            </div>
            <!-- Online status dot -->
            <div id="presence-{{ p.id }}" class="absolute bottom-0 right-0 w-3 h-3 {% if p.is_online %}bg-green-500{% else %}bg-gray-300{% endif %} border-2 border-white rounded-full"></div>
          </div>

          <div>
            <h2 class="font-bold text-lg">{{ p.display_name|default:p.user.email }}</h2>
            <p id="last-seen-{{ p.id }}" class="text-sm text-gray-500">
              {% if p.is_online %}Online{% else %}last seen {{ p.last_seen|timesince }} ago{% endif %}
            </p>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <a href="{% url 'inbox' %}" class="text-gray-500 hover:text-gray-700">
      ‚Üê Back
    </a>
  </div>

  <!-- Messages Container -->
  <div id="messages" class="bg-gray-50 p-6 h-[60vh] overflow-y-auto space-y-4">
    {% for message in chat_messages %}
      {% include "web/messaging/partials/message.html" %}
    {% endfor %}
  </div>

  <!-- Typing Indicator -->
  <div id="typing-indicator" class="bg-white px-6 py-2 text-sm text-gray-500 italic min-h-[2rem]">
  </div>

  <!-- Message Input -->
  <div class="bg-white rounded-b-2xl p-4">
    <form
      hx-post="{% url 'send_message' conversation.id %}"
      hx-target="#messages"
      hx-swap="beforeend"
      hx-on::after-request="this.reset(); setTimeout(() => { document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight }, 100)"
      class="flex gap-3">
      {% csrf_token %}

      <input
        name="body"
        id="message-input"
        class="flex-1 border border-gray-300 rounded-xl px-4 py-3 focus:ring-2 focus:ring-pink-500 focus:border-transparent"
        placeholder="Type your message‚Ä¶"
        autocomplete="off"
        required/>

      <button type="submit" class="bg-gradient-to-r from-pink-600 to-purple-600 text-white px-6 py-3 rounded-xl font-semibold hover:from-pink-700 hover:to-purple-700 transition flex items-center gap-2">
        <span>Send</span>
        <span>‚Üí</span>
      </button>
    </form>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const messages = document.getElementById('messages');
      const currentProfileId = "{{ profile.id }}";
      messages.scrollTop = messages.scrollHeight;

      // Handle custom WebSocket events (typing, presence, chat_message)
      const wsElement = document.querySelector('[ws-connect]');
      wsElement.addEventListener('htmx:wsBeforeMessage', (e) => {
          try {
              const data = JSON.parse(e.detail.message);
              
              if (data.type === 'typing') {
                  const indicator = document.getElementById('typing-indicator');
                  indicator.innerText = 'Someone is typing...';
                  clearTimeout(window.typingTimeout);
                  window.typingTimeout = setTimeout(() => {
                      indicator.innerText = '';
                  }, 3000);
                  e.preventDefault(); // Don't swap
              } else if (data.type === 'status') {
                  const dot = document.getElementById(`presence-${data.user}`);
                  const text = document.getElementById(`last-seen-${data.user}`);
                  if (dot) dot.className = `absolute bottom-0 right-0 w-3 h-3 ${data.status === 'online' ? 'bg-green-500' : 'bg-gray-300'} border-2 border-white rounded-full`;
                  if (text) text.innerText = data.status === 'online' ? 'Online' : 'Just now';
                  e.preventDefault();
              } else if (data.type === 'chat_message') {
                  // If I'm the sender, I already have the message from HTMX POST
                  if (data.sender_id === currentProfileId) {
                      e.preventDefault();
                      return;
                  }
                  
                  // Extract the message HTML from the OOB wrapper and insert it
                  const tempDiv = document.createElement('div');
                  tempDiv.innerHTML = data.html;
                  const oobDiv = tempDiv.querySelector('#messages');
                  if (oobDiv) {
                      messages.insertAdjacentHTML('beforeend', oobDiv.innerHTML);
                      // Trigger scroll after append
                      setTimeout(() => {
                          messages.scrollTop = messages.scrollHeight;
                      }, 100);
                  }
                  
                  e.preventDefault();
              }
          } catch (err) {
              console.error("WS Message Error:", err);
          }
      });

      // Typing ping via socket
      const input = document.getElementById('message-input');
      input.addEventListener('keyup', () => {
          const ws = htmx.values(wsElement).ws;
          if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(JSON.stringify({type: 'typing'}));
          }
      });
    });
  </script>

</div>

{% endblock %}
